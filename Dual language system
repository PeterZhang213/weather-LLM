import requests
import re

# WeatherAPI Key & Endpoint
API_KEY = "XXXXXXXX"
WEATHER_API_URL = "http://api.weatherapi.com/v1/forecast.json"

# Hugging Face Llama 3.2 API Config
LLAMA_API_URL = "https://api-inference.huggingface.co/models/meta-llama/Llama-3.2-1B"
HEADERS = {
    "Authorization": "Bearer hf_XXXXXXX",
    "Content-Type": "application/json"
}

CITY_TRANSLATIONS = {
    "ä¼¦æ•¦": "London", "åŒ—äº¬": "Beijing", "ä¸Šæµ·": "Shanghai",
    "å¹¿å·": "Guangzhou", "æ·±åœ³": "Shenzhen", "çº½çº¦": "New York",
    "æ´›æ‰çŸ¶": "Los Angeles", "å·´é»": "Paris", "ä¸œäº¬": "Tokyo", "æŸæ—": "Berlin",
    "æ›¼åˆ‡æ–¯ç‰¹": "Manchester"
}

CONDITION_TRANSLATIONS_ZH = {
    "Sunny": "æ™´", "Partly cloudy": "å¤šäº‘", "Cloudy": "å¤šäº‘", "Clear": "æ™´æœ—",  "Overcast": "é˜´", "Mist": "è–„é›¾",
    "Patchy rain possible": "å±€éƒ¨å¯èƒ½æœ‰é›¨", "Patchy snow possible": "å±€éƒ¨å¯èƒ½æœ‰é›ª",
    "Patchy sleet possible": "å±€éƒ¨å¯èƒ½æœ‰é›¨å¤¹é›ª", "Patchy freezing drizzle possible": "å±€éƒ¨å¯èƒ½æœ‰å†»æ¯›æ¯›é›¨",
    "Thundery outbreaks possible": "å¯èƒ½æœ‰é›·æš´", "Blowing snow": "é£é›ª", "Blizzard": "æš´é£é›ª",
    "Fog": "é›¾", "Freezing fog": "å†»é›¾", "Patchy light drizzle": "å±€éƒ¨å°æ¯›æ¯›é›¨", "Light drizzle": "å°æ¯›æ¯›é›¨",
    "Freezing drizzle": "å†»æ¯›æ¯›é›¨", "Heavy freezing drizzle": "å¼ºå†»æ¯›æ¯›é›¨", "Patchy light rain": "å±€éƒ¨å°é›¨",
    "Light rain": "å°é›¨", "Moderate rain": "ä¸­é›¨", "Heavy rain": "å¤§é›¨", "Light snow": "å°é›ª",
    "Moderate snow": "ä¸­é›ª", "Heavy snow": "å¤§é›ª", "Ice pellets": "å†°ç²’", "Light rain shower": "å°é˜µé›¨",
    "Moderate or heavy rain shower": "ä¸­åˆ°å¤§é˜µé›¨", "Torrential rain shower": "æš´é›¨",
    "Light snow shower": "å°é˜µé›ª", "Moderate or heavy snow shower": "ä¸­åˆ°å¤§é˜µé›ª",
    "Light showers of ice pellets": "å°å†°ç²’é˜µé›¨", "Moderate or heavy showers of ice pellets": "ä¸­åˆ°å¤§å†°ç²’é˜µé›¨",
    "Patchy light rain with thunder": "å±€éƒ¨å°é›¨ä¼´é›·", "Moderate or heavy rain with thunder": "ä¸­åˆ°å¤§é›¨ä¼´é›·",
    "Patchy light snow with thunder": "å±€éƒ¨å°é›ªä¼´é›·", "Moderate or heavy snow with thunder": "ä¸­åˆ°å¤§é›ªä¼´é›·"
}

def detect_language(text):
    return "zh" if re.search(r'[\u4e00-\u9fff]', text) else "en"

def extract_city(user_input, lang):
    if lang == "zh":
        for zh_city, en_city in CITY_TRANSLATIONS.items():
            if zh_city in user_input:
                return en_city, zh_city
        return None, None
    else:
        for zh_city, en_city in CITY_TRANSLATIONS.items():
            if en_city.lower() in user_input.lower():
                return en_city, en_city
        matches = re.findall(r"\b([A-Z][a-z]+(?:\s[A-Z][a-z]+)*)\b", user_input)
        if matches:
            return matches[0], matches[0]
    return None, None

def get_requested_day(user_input, lang):
    if lang == "zh":
        if "æ˜å¤©" in user_input:
            return "tomorrow"
        return "today"
    else:
        if "tomorrow" in user_input.lower():
            return "tomorrow"
        return "today"

def get_forecast(city, is_today):
    params = {"key": API_KEY, "q": city, "days": 2, "aqi": "no", "alerts": "no"}
    response = requests.get(WEATHER_API_URL, params=params)
    if response.status_code == 200:
        data = response.json()
        return data["current"] if is_today else data["forecast"]["forecastday"][1]["day"]
    else:
        return {"error": f"Failed to fetch forecast. {response.text}"}

def is_yes_no_sunny_question(text):
    keywords = ["sunny", "be sunny", "æ™´", "å‡ºå¤ªé˜³", "å˜æ™´"]
    yes_no_indicators = ["will", "æ˜¯å¦", "ä¼š", "å˜", "æ˜¯"]
    return any(k in text.lower() for k in keywords) and any(k in text.lower() for k in yes_no_indicators)

def is_hiking_question(text):
    return any(word in text.lower() for word in ["ç™»å±±", "hike", "hiking", "é€‚åˆçˆ¬å±±", "é€‚åˆç™»å±±"])

def is_kite_flying_question(text):
    return any(word in text.lower() for word in ["fly a kite", "æ”¾é£ç­", "é£ç­", "é€‚åˆæ”¾é£ç­"])

def is_shoe_question(text):
    return any(word in text.lower() for word in ["ç©¿ä»€ä¹ˆé‹", "é´å­è¿˜æ˜¯è¿åŠ¨é‹", "shoes", "sneakers or boots", "é‹å­", "è¿åŠ¨é‹", "boots"])

def handle_yes_no_sunny(forecast_data, lang, is_today):
    condition = forecast_data["condition"]["text"]
    temp = forecast_data.get("temp_c" if is_today else "avgtemp_c", "?")
    is_sunny = "sunny" in condition.lower() or "clear" in condition.lower()
    if lang == "zh":
        answer = "æ˜¯çš„ï¼Œä¼šçš„ã€‚" if is_sunny else "ä¸ï¼Œä¸ä¼šçš„ã€‚"
        return f"{answer} æ¸©åº¦å¤§çº¦æ˜¯ {temp}Â°Cã€‚"
    else:
        answer = "Yes, it will." if is_sunny else "No, it will not."
        return f"{answer} The temperature is around {temp}Â°C."

def handle_hiking_question(forecast_data, lang, day, city_display):
    condition_en = forecast_data.get("condition", {}).get("text", "")
    condition_zh = CONDITION_TRANSLATIONS_ZH.get(condition_en, condition_en)
    temp_c = forecast_data.get("temp_c") or forecast_data.get("avgtemp_c") or "?"
    try: temp_c = round(float(temp_c), 1)
    except: temp_c = "?"
    rain_chance = forecast_data.get("daily_chance_of_rain", 0)
    good_conditions = ["Sunny", "Clear", "Partly cloudy"]
    is_good = any(k.lower() in condition_en.lower() for k in good_conditions) and rain_chance < 40
    if lang == "zh":
        if is_good:
            return f"æ˜¯çš„ï¼Œ{day}{city_display}çš„å¤©æ°”å¾ˆé€‚åˆç™»å±±ï¼Œå› ä¸ºå¤©æ°”{condition_zh}ï¼Œæ¸©åº¦å¤§çº¦æ˜¯{temp_c}Â°Cã€‚"
        else:
            return f"æŠ±æ­‰ï¼Œ{day}{city_display}çš„å¤©æ°”ä¸é€‚åˆç™»å±±ï¼Œå› ä¸ºå¤©æ°”{condition_zh}ï¼Œå¯èƒ½ä¼šä¸‹é›¨æˆ–ä¸ç¨³å®šã€‚"
    else:
        if is_good:
            return f"Yes, the weather in {city_display} {day} is suitable for hiking because it is {condition_en.lower()} with around {temp_c}Â°C."
        else:
            return f"Sorry, the weather in {city_display} {day} is not good for hiking due to {condition_en.lower()} and possible rain."

def handle_kite_flying_question(forecast_data, lang, day, city_display):
    condition_en = forecast_data.get("condition", {}).get("text", "")
    condition_zh = CONDITION_TRANSLATIONS_ZH.get(condition_en, condition_en)
    wind_kph = forecast_data.get("wind_kph", 0)
    temp_c = forecast_data.get("temp_c") or forecast_data.get("avgtemp_c") or "?"
    try: temp_c = round(float(temp_c), 1)
    except: temp_c = "?"
    is_good = ("sunny" in condition_en.lower() or "clear" in condition_en.lower() or "partly" in condition_en.lower()) and 10 <= wind_kph <= 25
    if lang == "zh":
        if is_good:
            return f"æ˜¯çš„ï¼Œ{day}{city_display}çš„å¤©æ°”é€‚åˆæ”¾é£ç­ï¼Œå› ä¸ºå¤©æ°”{condition_zh}ï¼Œé£é€Ÿä¸º{wind_kph}å…¬é‡Œæ¯å°æ—¶ã€‚"
        else:
            return f"ä¸å»ºè®®{day}åœ¨{city_display}æ”¾é£ç­ï¼Œå› ä¸ºå¤©æ°”{condition_zh}ï¼Œé£é€Ÿä¸º{wind_kph}å…¬é‡Œæ¯å°æ—¶ï¼Œä¸å¤ªé€‚åˆã€‚"
    else:
        if is_good:
            return f"Yes, you can fly a kite in {city_display} {day}. The weather is {condition_en.lower()} with wind speed at {wind_kph} kph."
        else:
            return f"It's not ideal to fly a kite in {city_display} {day} because it's {condition_en.lower()} with wind speed at {wind_kph} kph."

def handle_shoe_question(forecast_data, lang, day, city_display):
    condition_en = forecast_data.get("condition", {}).get("text", "")
    condition_zh = CONDITION_TRANSLATIONS_ZH.get(condition_en, condition_en)
    temp_c = forecast_data.get("temp_c") or forecast_data.get("avgtemp_c") or "?"
    try: temp_c = round(float(temp_c), 1)
    except: temp_c = "?"
    bad_weather_keywords = ["rain", "fog", "storm", "snow", "shower", "drizzle"]
    if lang == "zh":
        if any(k in condition_en.lower() for k in bad_weather_keywords):
            return f"ä¾æˆ‘æ‰€è§ï¼Œ{day}{city_display}çš„å¤©æ°”ä¸æ˜¯å¾ˆå¥½ï¼Œç©¿é´å­å‡ºé—¨ä¼šå¥½ä¸€ç‚¹ã€‚ç°åœ¨çš„å¤©æ°”æ˜¯{condition_zh}ï¼Œæ¸©åº¦å¤§çº¦æ˜¯{temp_c}Â°Cã€‚"
        else:
            return f"{day}{city_display}å¤©æ°”å¾ˆå¥½ï¼Œä½ åº”è¯¥ç©¿è¿åŠ¨é‹å‡ºé—¨ã€‚ç°åœ¨çš„å¤©æ°”æ˜¯{condition_zh}ï¼Œæ¸©åº¦å¤§çº¦æ˜¯{temp_c}Â°Cã€‚"
    else:
        if any(k in condition_en.lower() for k in bad_weather_keywords):
            return f"Based on the weather in {city_display} {day}, it's better to wear boots. It's currently {condition_en.lower()} with about {temp_c}Â°C."
        else:
            return f"The weather in {city_display} {day} is good, you should wear sneakers. It's currently {condition_en.lower()} with about {temp_c}Â°C."

def query_llama(prompt):
    payload = {
        "inputs": prompt,
        "parameters": {
            "max_new_tokens": 50,
            "temperature": 0.5,
            "top_p": 0.8,
            "stop": ["\n"]
        }
    }
    response = requests.post(LLAMA_API_URL, headers=HEADERS, json=payload)
    if response.status_code == 200:
        try:
            result = response.json()
            if isinstance(result, dict) and "generated_text" in result:
                return result["generated_text"].strip()
            elif isinstance(result, list) and "generated_text" in result[0]:
                return result[0]["generated_text"].strip()
        except Exception:
            return None
    return None



# MAIN LOOP
# MAIN LOOP
if __name__ == "__main__":
    print("\033[93mğŸŒ Welcome to the AI Weather Chatbot! Type 'exit' to quit.\033[0m\n")

    while True:
        user_query = input(" Ask me any weather questions! Type 'suggest' if you need ideas:  ").strip()

        if user_query.lower() == "exit" or user_query == "é€€å‡º":
            print("\033[91mğŸ‘‹ Goodbye!\033[0m" if detect_language(user_query) == "en" else "\033[91mğŸ‘‹ å†è§ï¼\033[0m")
            break

        # Show examples if user wants suggestions
        if user_query.lower() == "suggest" or user_query == "å»ºè®®":
            print("\n\033[92mğŸ§  Example Questions:")
            print("Q: ä»Šå¤©ä¼¦æ•¦å¤©æ°”å¦‚ä½•ï¼Ÿ")
            print("A: ä»Šå¤©ä¼¦æ•¦çš„å¤©æ°”æ˜¯æ™´æœ—ï¼Œæ¸©åº¦å¤§çº¦æ˜¯10.1Â°Cã€‚\n")
            print("Q: Should I fly a kite in Manchester today?")
            print("A: Yes, you can fly a kite in Manchester today. The weather is clear with wind speed at 17.3 kph.\n")
            print("Q: æˆ‘ä»Šå¤©åº”è¯¥åœ¨æ›¼åˆ‡æ–¯ç‰¹ç©¿ä»€ä¹ˆé‹å­å‡ºé—¨ï¼Ÿé´å­è¿˜æ˜¯è¿åŠ¨é‹ï¼Ÿ")
            print("A: ä»Šå¤©æ›¼åˆ‡æ–¯ç‰¹å¤©æ°”å¾ˆå¥½ï¼Œä½ åº”è¯¥ç©¿è¿åŠ¨é‹å‡ºé—¨, ç°åœ¨çš„å¤©æ°”æ˜¯æ™´æœ—ï¼Œæ¸©åº¦å¤§çº¦æ˜¯11.4Â°Cã€‚\n")
            print("Q: Will the weather in Manchester become sunny today?")
            print("A: Yes, it will. The temperature is around 7.2Â°C.\033[0m\n")
            continue

        lang = detect_language(user_query)
        city_en, city_display = extract_city(user_query, lang)
        if not city_en:
            print("\033[91mâš ï¸ Unable to detect city.\033[0m" if lang == "en" else "\033[91mâš ï¸ æ— æ³•è¯†åˆ«åŸå¸‚ã€‚\033[0m")
            continue

        day = get_requested_day(user_query, lang)
        day_str = "ä»Šå¤©" if lang == "zh" and day == "today" else "æ˜å¤©" if lang == "zh" else "today" if day == "today" else "tomorrow"
        forecast_data = get_forecast(city_en, day == "today")
        if "error" in forecast_data:
            print("\033[91mâš ï¸", forecast_data["error"], "\033[0m")
            continue

        if is_hiking_question(user_query):
            response = handle_hiking_question(forecast_data, lang, day_str, city_display)
        elif is_kite_flying_question(user_query):
            response = handle_kite_flying_question(forecast_data, lang, day_str, city_display)
        elif is_shoe_question(user_query):
            response = handle_shoe_question(forecast_data, lang, day_str, city_display)
        elif is_yes_no_sunny_question(user_query):
            response = handle_yes_no_sunny(forecast_data, lang, day == "today")
        else:
            response = "å¯¹ä¸èµ·ï¼Œæˆ‘æš‚æ—¶æ— æ³•ç†è§£ä½ çš„é—®é¢˜ã€‚" if lang == "zh" else "Sorry, I couldn't understand your question."

        print(f"\n\033[94mğŸ¤– {response}\033[0m")
        print("\n\033[93mğŸ”„ Ask another question or type 'exit' to quit.\033[0m\n")
